<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Malla Curricular - ITM (Jefe de Programa)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            position: relative;
        }

        .filters {
            width: 25%;
            padding: 2rem;
            background: #f9fafb;
            border-right: 1px solid #d1d5db;
        }

        .courses {
            width: 75%;
            padding: 2rem;
        }

        .header {
            background: #1e40af;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

            .header h1 {
                font-size: 1.5rem;
                font-weight: 600;
                margin: 0;
            }

        .error-message {
            color: #dc2626;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .success-message { /* Nuevo estilo para mensajes de éxito */
            color: #10b981;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .retry-btn, .export-btn, .save-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            margin: 0 auto 1rem;
        }

            .retry-btn:hover, .export-btn:hover, .save-btn:hover {
                background: #2563eb;
            }

        .filter-group, .form-group {
            margin-bottom: 1.5rem;
        }

        .filter-label, .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }

        .filter-select, .course-select, .form-input, .form-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }

            .filter-select:focus, .course-select:focus, .form-input:focus, .form-select:focus {
                border-color: #3b82f6;
                outline: none;
            }

        .apply-btn, .submit-btn, .login-btn, .logout-btn { /* Agregados login-btn y logout-btn */
            width: 100%;
            padding: 0.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem; /* Añadido margen superior */
        }

            .apply-btn:hover, .submit-btn:hover, .login-btn:hover, .logout-btn:hover {
                background: #2563eb;
            }

        .logout-btn { /* Estilo específico para el botón de logout */
            background: #ef4444; /* Rojo para logout */
            margin-top: 2rem; /* Más margen para separarlo */
        }

            .logout-btn:hover {
                background: #dc2626;
            }

        .semester-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .semester {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

            .semester h3 {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

        .course {
            background: white;
            border-left: 4px solid transparent;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .course-green {
            border-left-color: #10b981;
        }

        .course-blue {
            border-left-color: #3b82f6;
        }

        .course-purple {
            border-left-color: #8b5cf6;
        }

        .course-red {
            border-left-color: #ef4444;
        }

        .course-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .course-code {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .course-prerequisite {
            font-size: 0.7rem;
            color: #dc2626;
            display: none;
        }
        .summary-box {
            margin-top: 1rem;
            background-color: #e2e8f0;
            border: 2px solid black;
            border-radius: 4px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            text-align: center;
            font-weight: bold;
            color: #000;
        }

        .summary-cell {
            border: 1px solid black;
            padding: 0.5rem;
        }
        .legend { /* Para la lista de definiciones */
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #374151;
            line-height: 1.4;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-top: 0.25rem;
        }

            .remove-btn:hover {
                background: #dc2626;
            }

        .color-palette {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

            .color-palette h4 {
                font-size: 0.9rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

        .color-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .color-swatch {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            border-radius: 2px;
        }
        .color-palette {
            position: static; /* ❗ Elimina cualquier posicionamiento absoluto */
            margin-top: 1.5rem;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #courses-semester-P {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: stretch;
            flex-wrap: nowrap; /* ❗ No permite que bajen de línea */
            overflow-x: auto; /* Permite desplazamiento si son muchas */
            gap: 1rem;
            padding: 1rem 0;
        }

            #courses-semester-P .course {
                min-width: 200px; /* Cada tarjeta de curso */
                flex: 0 0 auto; /* No se expanden ni encogen */
            }
            .color-palette h4 {
                font-size: 0.9rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                text-align: center;
            }

        .color-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .color-swatch {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .filters img {
            max-width: 100%;
            height: auto;
            margin-bottom: 1.5rem;
        }

        /* Estilos para el formulario de login */
        .login-container {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

            .login-container h2 {
                font-size: 2rem;
                font-weight: 700;
                margin-bottom: 2rem;
                color: #1e40af;
            }

        .login-form .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .login-form .form-label {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .login-form .form-input {
            font-size: 1rem;
            padding: 0.75rem;
        }

        /* Ocultar/mostrar secciones */
        .hidden {
            display: none !important;
        }


        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .filters, .courses {
                width: 100%;
            }

            .semester-grid {
                grid-template-columns: 1fr;
            }

            .color-palette {
                position: static;
                margin-top: 1rem;
                width: 100%;
            }

            .top-left-image {
                width: 60px;
                top: 0.25rem;
                left: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div id="login-section" class="login-container">
        <img src="logo2020.png" alt="ITM Logo" class="mx-auto mb-6 w-32" />
        <h2>Iniciar Sesión</h2>
        <div class="error-message" id="login-error-message"></div>
        <form id="login-form" class="login-form">
            <div class="form-group">
                <label for="login-email" class="form-label">Correo Electrónico</label>
                <input type="email" id="login-email" class="form-input" required>
            </div>
            <div class="form-group">
                <label for="login-password" class="form-label">Contraseña</label>
                <input type="password" id="login-password" class="form-input" required>
            </div>
            <button type="submit" class="login-btn">Acceder</button>
        </form>
    </div>

    <div id="malla-section" class="container hidden">
        <div class="filters">
            <img src="logo2020.png" alt="ITM Logo" />
            <h2 class="text-xl font-bold text-gray-800 mb-4">Filtros</h2>
            <div class="error-message" id="error-message"></div>
            <div class="success-message" id="success-message"></div> <div class="filter-group">
                <label class="filter-label">Semestre</label>
                <select class="filter-select" id="semester-filter">
                    <option value="all">Todos los Semestres</option>
                    <option value="1">Semestre 1</option>
                    <option value="2">Semestre 2</option>
                    <option value="3">Semestre 3</option>
                    <option value="4">Semestre 4</option>
                    <option value="5">Semestre 5</option>
                    <option value="6">Semestre 6</option>
                    <option value="7">Semestre 7</option>
                    <option value="8">Semestre 8</option>
                    <option value="9">Semestre 9</option>
                    <option value="10">Semestre 10</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Opciones</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="show-prerequisites" class="mr-2 rounded text-blue-600">
                        Mostrar Prerrequisitos
                    </label>
                </div>
            </div>

            <button class="apply-btn" onclick="applyFilters()">Aplicar Filtros</button>
            <div class="legend-box mt-6">
                <div class="summary-box grid grid-cols-3 border border-black text-center">
                    <div class="summary-cell font-bold">TPS</div>
                    <div class="summary-cell font-bold">TIS</div>
                    <div class="summary-cell font-bold">Créditos</div>
                    <div class="summary-cell font-bold">TPT</div>
                    <div class="summary-cell font-bold">TIT</div>
                    <div class="summary-cell font-bold">#</div>
                </div>
                <div class="legend mt-2 text-sm text-gray-700">
                    <p><strong>TPS:</strong> Trabajo Presencial Semanal</p>
                    <p><strong>TIS:</strong> Trabajo Independiente Semanal</p>
                    <p><strong>TPT:</strong> Trabajo Presencial Total</p>
                    <p><strong>TIT:</strong> Trabajo Independiente Total</p>
                    <p><strong>#:</strong> Número total de créditos</p>
                </div>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mt-6 mb-4">Crear Asignatura</h2>
            <div class="form-group">
                <label class="form-label">Código</label>
                <input type="text" id="new-code" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Asignatura</label>
                <input type="text" id="new-name" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Prerrequisito</label>
                <select id="new-prerequisite" class="form-select">
                    <option value="">Ninguno</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Tipo De Asignatura</label>
                <select id="new-color" class="form-select" required>
                    <option value="course-green">Ciencias Básicas</option>
                    <option value="course-blue">Ciencias Básicas Tecnología - Ingeniería</option>
                    <option value="course-purple">Formación Profesional</option>
                    <option value="course-red">Formación Complementaria</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Trabajo Presencial Semanal (TPS)</label>
                <input type="number" id="new-tps" class="form-input" min="0" required>
            </div>

            <div class="form-group">
                <label class="form-label">Trabajo Independiente Semanal (TIS)</label>
                <input type="number" id="new-tis" class="form-input" min="0" required>
            </div>
            <div class="form-group">
                <label class="form-label">Tipo</label>
                <select id="new-type" class="form-select" required>
                    <option value="Teorica">Teórica</option>
                    <option value="Teorico-Practica">Teórico-Práctica</option>
                    <option value="Practica">Práctica</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Créditos</label>
                <input type="number" id="new-credits" class="form-input" min="1" required>
            </div>


            <button class="submit-btn" onclick="createCourse()">Crear Asignatura</button>
            <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>

            <div class="color-palette">
                <h4>Leyenda de Colores</h4>
                <div class="color-item">
                    <div class="color-swatch" style="background-color: #10b981;"></div>
                    <span>Ciencias Básicas</span>
                </div>
                <div class="color-item">
                    <div class="color-swatch" style="background-color: #3b82f6;"></div>
                    <span>Ciencias Básicas Tecnología - Ingeniería</span>
                </div>
                <div class="color-item">
                    <div class="color-swatch" style="background-color: #8b5cf6;"></div>
                    <span>Formación Profesional</span>
                </div>
                <div class="color-item">
                    <div class="color-swatch" style="background-color: #ef4444;"></div>
                    <span>Formación Complementaria</span>
                </div>
            </div>

        </div>
        <div class="courses">
            <div class="header">
                <h1>Malla Curricular - ITM</h1>
            </div>
            <button class="retry-btn" onclick="fetchCourses()">Reintentar Carga de Cursos</button>
            <button class="export-btn" onclick="exportToPDF()">Exportar Malla a PDF</button>
            <button class="save-btn" onclick="saveMalla()">Guardar Malla</button>
            <div class="semester-grid" id="semester-grid"></div>



            <div id="courses-semester-P" class="flex flex-wrap justify-center gap-4 mt-4"></div>
        </div>

    </div>
    <script>
        let courses = {};
        const addedCourses = new Map();
        const API_BASE_URL = 'http://localhost:49513'; // Asegúrate de que este puerto sea el correcto

        // --- Funciones de Autenticación (Sin Cambios) ---

        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginErrorMessage = document.getElementById('login-error-message');
            loginErrorMessage.style.display = 'none';

            const formData = new URLSearchParams();
            formData.append('Email', email);
            formData.append('Contrasena', password);

            try {
                const response = await fetch(`${API_BASE_URL}/Auth/Login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: formData.toString()
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        localStorage.setItem('isAuthenticated', 'true');
                        localStorage.setItem('userId', data.userId);
                        localStorage.setItem('userName', data.userName);

                        showMallaSection();
                        fetchCourses();
                    } else {
                        loginErrorMessage.textContent = data.message || 'Credenciales incorrectas.';
                        loginErrorMessage.style.display = 'block';
                    }
                } else {
                    if (response.headers.get('Content-Type')?.includes('text/html')) {
                        loginErrorMessage.textContent = `Error de validación en el servidor. Verifica tus datos.`;
                    } else {
                        const errorData = await response.json();
                        loginErrorMessage.textContent = errorData.message || `Error en el servidor: ${response.status} ${response.statusText}`;
                    }
                    loginErrorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error durante el inicio de sesión:', error);
                loginErrorMessage.textContent = `No se pudo conectar al servidor: ${error.message}. Asegúrate de que el backend esté ejecutándose.`;
                loginErrorMessage.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            showLoginSection();
        }

        function checkAuthAndRender() {
            if (localStorage.getItem('isAuthenticated') === 'true') {
                showMallaSection();
                fetchCourses();
            } else {
                showLoginSection();
            }
        }

        function showLoginSection() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('malla-section').classList.add('hidden');
        }

        function showMallaSection() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('malla-section').classList.remove('hidden');
        }


        // ----------------------------------------------------------------------
        // --- Funciones del Buscador en Tiempo Real (Modificada la Generación HTML) ---

        /**
         * Genera el HTML para el custom select con buscador.
         * @param {number|string} semester - El número de semestre o 'P'.
         */
        function createCustomSelect(semester) {
            let availableCourses = Object.values(courses).filter(c => !addedCourses.has(c.code));

            // Ordenar alfabéticamente por nombre
            availableCourses.sort((a, b) => {
                const nameA = a.name.toUpperCase();
                const nameB = b.name.toUpperCase();
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            });

            const optionsHtml = availableCourses
                .map(c => `<div class="custom-option p-2 hover:bg-blue-100 cursor-pointer whitespace-nowrap" data-value="${c.code}" onclick="selectCustomOption(this, '${semester}', '${c.code}')">${c.name} (${c.code})</div>`)
                .join('');

            // ✅ MODIFICACIÓN CLAVE: Se cambió el ancho a un valor fijo de 400px.
            return `
                <div class="custom-select-container relative mb-4">
                    <button type="button" class="custom-select-button course-select p-2 border border-gray-300 rounded-md w-full text-left bg-white text-gray-500 hover:text-gray-700" onclick="toggleCustomDropdown(this)">
                        Seleccione un curso...
                    </button>
                    <div class="custom-dropdown absolute z-10 bg-white border border-gray-300 rounded-md shadow-lg max-h-96 overflow-y-auto hidden"
                         style="width: 400px;"
                         >
                        <input type="text" class="custom-search-input p-2 border-b border-gray-300 w-full sticky top-0" placeholder="Buscar curso..." onkeyup="filterCustomOptions(this)">
                        <div class="custom-options-list">
                            ${optionsHtml || '<div class="p-2 text-gray-500">No hay cursos disponibles.</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleCustomDropdown(button) {
            // Cierra todos los otros dropdowns abiertos
            document.querySelectorAll('.custom-dropdown').forEach(d => {
                if (d !== button.nextElementSibling) {
                    d.classList.add('hidden');
                }
            });

            const dropdown = button.nextElementSibling;
            dropdown.classList.toggle('hidden');

            if (!dropdown.classList.contains('hidden')) {
                const searchInput = dropdown.querySelector('.custom-search-input');
                searchInput.value = '';
                searchInput.focus();
                dropdown.querySelectorAll('.custom-option').forEach(option => option.style.display = 'block');
            }
        }

        function filterCustomOptions(input) {
            const filter = input.value.toUpperCase();
            const optionsList = input.nextElementSibling;
            const options = optionsList.querySelectorAll('.custom-option');

            options.forEach(option => {
                const text = option.textContent || option.innerText;
                option.style.display = text.toUpperCase().includes(filter) ? 'block' : 'none';
            });
        }

        function selectCustomOption(optionDiv, semester, courseCode) {
            const button = optionDiv.closest('.custom-select-container').querySelector('.custom-select-button');
            const dropdown = optionDiv.closest('.custom-dropdown');

            addCourseLogic(courseCode, semester);

            dropdown.classList.add('hidden');
            button.textContent = 'Seleccione un curso...';
        }

        function addCourseLogic(courseCode, semester) {
            if (!courseCode || addedCourses.has(courseCode)) return;

            const course = courses[courseCode];
            if (!course) {
                console.error(`Curso no encontrado: ${courseCode}`);
                return;
            }

            const prereqCodes = course.prerequisiteCodes || [];
            const missingPrereqs = prereqCodes.filter(prCode => !addedCourses.has(prCode));

            if (missingPrereqs.length > 0) {
                const missingPrereqNames = missingPrereqs.map(code => courses[code] ? courses[code].name : code);
                alert(`No puedes agregar "${course.name}" porque debes agregar primero:\n• ${missingPrereqNames.join("\n• ")}`);
                return;
            }

            addedCourses.set(courseCode, semester);
            renderSemesters();
        }


        // ----------------------------------------------------------------------
        // --- Funciones de la Malla Curricular (Sin Cambios) ---

        async function fetchCourses() {
            const errorMessage = document.getElementById('error-message');
            errorMessage.style.display = 'none';
            const grid = document.getElementById('semester-grid');
            grid.innerHTML = '<p class="text-center">Cargando cursos...</p>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/cursos/todos`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                courses = {};
                data.forEach(course => {
                    const prerequisiteCodes = Array.isArray(course.Prerequisitos)
                        ? course.Prerequisitos.map(p => p.Codigo)
                        : [];

                    courses[course.Codigo] = {
                        code: course.Codigo,
                        name: course.Asignatura,
                        prerequisiteCodes: prerequisiteCodes,
                        color: course.Color,
                        credits: course.Creditos,
                        tps: course.TPS,
                        tis: course.TIS
                    };
                });


                const prereqSelect = document.getElementById('new-prerequisite');
                prereqSelect.innerHTML = `<option value="">Ninguno</option>`;
                Object.values(courses).forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.code;
                    opt.textContent = `${c.name} (${c.code})`;
                    prereqSelect.appendChild(opt);
                });

                renderSemesters();
            } catch (error) {
                console.error('Error al cargar los cursos:', error);
                errorMessage.textContent = `No se pudieron cargar los cursos: ${error.message}.`;
                errorMessage.style.display = 'block';
                grid.innerHTML = '<p class="text-center text-red-600">Error al cargar la malla.</p>';
            }
        }

        function addCourse(select, semester) {
            const courseCode = select.value;
            if (!courseCode) return;

            addCourseLogic(courseCode, semester);
        }


        function renderSemesters() {
            const grid = document.getElementById('semester-grid');
            grid.innerHTML = '';

            // Generar los 10 semestres normales
            for (let i = 1; i <= 10; i++) {
                const semester = document.createElement('div');
                semester.className = 'semester';
                semester.setAttribute('data-semester', i);
                semester.innerHTML = `
                <h3>Semestre ${i}</h3> ${createCustomSelect(i)} 
                <div id="courses-semester-${i}"></div>
            `;
                grid.appendChild(semester);
            }

            // Agregar bloque de Materias Propedéuticas (en horizontal)
            const propedeutic = document.createElement('div');
            propedeutic.className = 'semester mt-10';
            propedeutic.setAttribute('data-semester', 'P');
            propedeutic.style.gridColumn = "1 / -1";
            propedeutic.innerHTML = `
            <h3 class="text-center mb-4 text-lg font-semibold">Materias Propedéuticas</h3>
            <div class="mx-auto" style="max-width: 600px;"> 
                ${createCustomSelect('P')} 
            </div>
            <div id="courses-semester-P"
                class="flex flex-wrap justify-center gap-4 mt-4">
            </div>
        `;
            grid.appendChild(propedeutic);

            addedCourses.forEach((semester, courseCode) => {
                const course = courses[courseCode];
                if (course) {
                    const courseList = document.getElementById(`courses-semester-${semester}`);
                    if (!courseList) return;

                    const courseDiv = document.createElement('div');
                    courseDiv.className = `course ${course.color} p-3 rounded-lg shadow text-center`;
                    courseDiv.setAttribute('data-code', courseCode);
                    courseDiv.setAttribute('data-semester', semester);

                    const prereqsHtml = course.prerequisiteCodes && course.prerequisiteCodes.length > 0
                        ? `<div class="text-xs mt-1 text-gray-500">Req: ${course.prerequisiteCodes.join(', ')}</div>`
                        : '';

                    courseDiv.innerHTML = `
                        <div>
                            <div class="course-title font-semibold">${course.name}</div>
                            <div class="course-code text-sm text-gray-600">${course.code}</div>
                            ${prereqsHtml}
                            <div class="text-xs mt-1 text-gray-600">
                                <span class="tps">TPS: ${course.tps || 0}</span> |
                                <span class="tis">TIS: ${course.tis || 0}</span> |
                                <span class="creditos">Créditos: ${course.credits || 0}</span>
                            </div>
                        </div>
                        <button class="remove-btn mt-2 bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded" onclick="removeCourse(this, '${courseCode}')">Remover</button>
                    `;

                    courseList.appendChild(courseDiv);
                }
            });

            if (typeof applyFilters === 'function') {
                applyFilters();
            }
            computeSemesterSums();
        }


        function removeCourse(button, courseCode) {
            addedCourses.delete(courseCode);
            renderSemesters();
        }

        async function createCourse() {
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            const code = document.getElementById('new-code').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const prerequisiteCode = document.getElementById('new-prerequisite').value;
            const color = document.getElementById('new-color').value;
            const tps = parseInt(document.getElementById('new-tps').value);
            const tis = parseInt(document.getElementById('new-tis').value);
            const tipo = document.getElementById('new-type').value;
            const creditos = parseInt(document.getElementById('new-credits').value);

            if (!code || !name || !color || !tipo || isNaN(tps) || isNaN(tis) || isNaN(creditos)) {
                errorMessage.textContent = 'Por favor, completa todos los campos obligatorios.';
                errorMessage.style.display = 'block';
                return;
            }

            const payload = {
                Codigo: code,
                Asignatura: name,
                Color: color,
                TPS: tps,
                TIS: tis,
                Tipo: tipo,
                Creditos: creditos,
                PrerequisitoCodigos: prerequisiteCode ? [prerequisiteCode] : []
            };


            try {
                const response = await fetch(`${API_BASE_URL}/api/cursos/crear`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorText = `Error HTTP: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData?.message) errorText = errorData.message;
                    } catch { }
                    throw new Error(errorText);
                }

                document.getElementById('new-code').value = '';
                document.getElementById('new-name').value = '';
                document.getElementById('new-prerequisite').value = '';
                document.getElementById('new-color').value = 'course-green';
                document.getElementById('new-tps').value = '';
                document.getElementById('new-tis').value = '';
                document.getElementById('new-type').value = 'Teorica';
                document.getElementById('new-credits').value = '';

                successMessage.textContent = 'Asignatura creada exitosamente.';
                successMessage.style.display = 'block';
                setTimeout(() => successMessage.style.display = 'none', 3000);

                await fetchCourses();
            } catch (error) {
                console.error('Error al crear el curso:', error);
                errorMessage.textContent = `Error al crear el curso: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        }


        // --- Funciones sin cambios significativos ---

        function applyFilters() {
            const semesterFilter = document.getElementById('semester-filter')?.value;
            const showPrerequisites = document.getElementById('show-prerequisites')?.checked;

            document.querySelectorAll('.semester').forEach(semester => {
                const semesterNum = semester.getAttribute('data-semester');
                semester.style.display = (semesterFilter === 'all' || semesterFilter === semesterNum) ? 'block' : 'none';
            });

            document.querySelectorAll('.course-prerequisite').forEach(prereq => {
                prereq.style.display = showPrerequisites ? 'block' : 'none';
            });
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const coursesSection = document.querySelector('.courses');
            const filtersSection = document.querySelector('.filters');
            const retryBtn = document.querySelector('.retry-btn');
            const exportBtn = document.querySelector('.export-btn');
            const saveBtn = document.querySelector('.save-btn');
            const colorPalette = document.querySelector('.color-palette');
            const logoutBtn = document.querySelector('.logout-btn');

            const courseSelects = document.querySelectorAll('.custom-select-container');
            const removeButtons = document.querySelectorAll('.remove-btn');
            const summaryBoxes = document.querySelectorAll('.semester-summary');

            [filtersSection, retryBtn, exportBtn, saveBtn, colorPalette, logoutBtn].forEach(el => {
                if (el) el.style.display = 'none';
            });
            courseSelects.forEach(sel => sel.style.display = 'none');
            removeButtons.forEach(btn => btn.style.display = 'none');
            summaryBoxes.forEach(box => box.style.display = 'none');


            try {
                const canvas = await html2canvas(coursesSection, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    scrollX: 0,
                    scrollY: 0
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const imgWidth = 190;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 20;

                doc.setFontSize(16);
                doc.text('Malla Curricular - ITM', 10, 10);

                doc.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - position - 10);

                while (heightLeft > 0) {
                    doc.addPage();
                    position = 10;
                    doc.addImage(imgData, 'JPEG', 10, position - heightLeft, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - 10);
                }

                doc.save('malla_curricular.pdf');
            } catch (error) {
                console.error('Error al generar el PDF:', error);
                const errorMsg = document.getElementById('error-message');
                if (errorMsg) {
                    errorMsg.textContent = 'Error al generar el PDF. Revisa la consola.';
                    errorMsg.style.display = 'block';
                }
            } finally {
                [filtersSection, retryBtn, exportBtn, saveBtn, colorPalette, logoutBtn].forEach(el => {
                    if (el) el.style.display = 'block';
                });
                courseSelects.forEach(sel => sel.style.display = 'block');
                removeButtons.forEach(btn => btn.style.display = 'block');
                summaryBoxes.forEach(box => box.style.display = 'block');
            }
        }


        async function saveMalla() {
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            const nombreMalla = prompt("Ingrese un nombre para la malla:");
            if (!nombreMalla || nombreMalla.trim() === "") {
                alert("Debe ingresar un nombre para la malla.");
                return;
            }
            const Version = prompt("Ingrese version de la malla:");
            if (!Version || Version.trim() === "") {
                alert("Debe ingresar una version para la malla.");
                return;
            }
            const fechaCreacion = new Date().toISOString();


            const malla = {
                nombre: nombreMalla.trim(),
                Version: Version.trim(),
                fechaCreacion: fechaCreacion,
                courses: Array.from(addedCourses).map(([code, semester]) => ({
                    Codigo: code,
                    Semestre: semester === 'P' ? 11 : semester,
                }))

            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/mallas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(malla)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error HTTP: ${response.status} ${response.statusText}`);
                }
                successMessage.textContent = 'Malla guardada exitosamente.';
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Error al guardar la malla:', error);
                errorMessage.textContent = `Error al guardar la malla: ${error.message}.`;
                errorMessage.style.display = 'block';
            }
        }

        function computeSemesterSums() {
            for (let i = 1; i <= 10; i++) {
                computeForSemester(i);
            }
            computeForSemester('P');
        }

        function computeForSemester(semesterKey) {
            const cont = document.getElementById(`courses-semester-${semesterKey}`);
            if (!cont) return;

            const cursos = cont.querySelectorAll(".course");

            const prev = cont.querySelector(".semester-summary");
            if (prev) prev.remove();

            if (cursos.length) {
                let tps_total = 0, tis_total = 0, creditos_total = 0;

                cursos.forEach(c => {
                    if (c.classList.contains("disabled")) return;

                    const courseCode = c.getAttribute('data-code');
                    const courseData = courses[courseCode];

                    if (courseData) {
                        tps_total += courseData.tps || 0;
                        tis_total += courseData.tis || 0;
                        creditos_total += courseData.credits || 0;
                    }
                });

                const tps_hours = tps_total * 16;
                const tis_hours = tis_total * 16;
                const total_credits = creditos_total;

                const box = document.createElement("div");
                box.className = "semester-summary mt-2 text-center text-xs";

                box.innerHTML = `
                    <div class="grid grid-cols-3 border border-black" style="font-size: 1.25rem;">

                        <div class="col-span-2 grid grid-cols-2 border-r border-black bg-gray-100">

                            <div class="border-b border-black font-bold text-lg p-1">${tps_total}</div>
                            <div class="border-b border-black border-l font-bold text-lg p-1">${tis_total}</div>

                            <div class="font-bold text-lg p-1">${tps_hours}</div>
                            <div class="font-bold border-l border-black text-lg p-1">${tis_hours}</div>
                        </div>

                        <div class="flex items-center justify-center text-3xl font-bold text-gray-700 bg-gray-200 border-l border-black">
                            ${total_credits}
                        </div>
                    </div>
                `;
                cont.appendChild(box);
            }
        }


        // --- Inicialización ---

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            checkAuthAndRender();

            document.addEventListener('click', (event) => {
                if (!event.target.closest('.custom-select-container')) {
                    document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.add('hidden'));
                }
            });
        });
    </script>
</body>
</html>