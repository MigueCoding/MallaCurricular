<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Malla Curricular - ITM (Jefe de Programa)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            position: relative;
        }

        .filters {
            width: 25%;
            padding: 2rem;
            background: #f9fafb;
            border-right: 1px solid #d1d5db;
        }

        .courses {
            width: 75%;
            padding: 2rem;
        }

        .header {
            background: #1e40af;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

            .header h1 {
                font-size: 1.5rem;
                font-weight: 600;
                margin: 0;
            }

        .error-message {
            color: #dc2626;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .success-message { /* Nuevo estilo para mensajes de 칠xito */
            color: #10b981;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .retry-btn, .export-btn, .save-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            margin: 0 auto 1rem;
        }

            .retry-btn:hover, .export-btn:hover, .save-btn:hover {
                background: #2563eb;
            }

        .filter-group, .form-group {
            margin-bottom: 1.5rem;
        }

        .filter-label, .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }

        .filter-select, .course-select, .form-input, .form-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }

            .filter-select:focus, .course-select:focus, .form-input:focus, .form-select:focus {
                border-color: #3b82f6;
                outline: none;
            }

        .apply-btn, .submit-btn, .login-btn, .logout-btn { /* Agregados login-btn y logout-btn */
            width: 100%;
            padding: 0.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem; /* A침adido margen superior */
        }

            .apply-btn:hover, .submit-btn:hover, .login-btn:hover, .logout-btn:hover {
                background: #2563eb;
            }

        .logout-btn { /* Estilo espec칤fico para el bot칩n de logout */
            background: #ef4444; /* Rojo para logout */
            margin-top: 2rem; /* M치s margen para separarlo */
        }

            .logout-btn:hover {
                background: #dc2626;
            }

        .semester-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .semester {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

            .semester h3 {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

        .course {
            background: white;
            border-left: 4px solid transparent;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .course-green {
            border-left-color: #10b981;
        }

        .course-blue {
            border-left-color: #3b82f6;
        }

        .course-purple {
            border-left-color: #8b5cf6;
        }

        .course-red {
            border-left-color: #ef4444;
        }

        .course-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .course-code {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .course-prerequisite {
            font-size: 0.7rem;
            color: #dc2626;
            display: none;
        }
        .summary-box {
            margin-top: 1rem;
            background-color: #e2e8f0;
            border: 2px solid black;
            border-radius: 4px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            text-align: center;
            font-weight: bold;
            color: #000;
        }

        .summary-cell {
            border: 1px solid black;
            padding: 0.5rem;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-top: 0.25rem;
        }

            .remove-btn:hover {
                background: #dc2626;
            }

        .color-palette {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

            .color-palette h4 {
                font-size: 0.9rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

        .color-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .color-swatch {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            border-radius: 2px;
        }

        .filters img {
            max-width: 100%;
            height: auto;
            margin-bottom: 1.5rem;
        }

        /* Estilos para el formulario de login */
        .login-container {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

            .login-container h2 {
                font-size: 2rem;
                font-weight: 700;
                margin-bottom: 2rem;
                color: #1e40af;
            }

        .login-form .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .login-form .form-label {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .login-form .form-input {
            font-size: 1rem;
            padding: 0.75rem;
        }

        /* Ocultar/mostrar secciones */
        .hidden {
            display: none !important;
        }


        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .filters, .courses {
                width: 100%;
            }

            .semester-grid {
                grid-template-columns: 1fr;
            }

            .color-palette {
                position: static;
                margin-top: 1rem;
                width: 100%;
            }

            .top-left-image {
                width: 60px;
                top: 0.25rem;
                left: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div id="login-section" class="login-container">
        <img src="images.png" alt="ITM Logo" class="mx-auto mb-6 w-32" />
        <h2>Iniciar Sesi칩n</h2>
        <div class="error-message" id="login-error-message"></div>
        <form id="login-form" class="login-form">
            <div class="form-group">
                <label for="login-email" class="form-label">Correo Electr칩nico</label>
                <input type="email" id="login-email" class="form-input" required>
            </div>
            <div class="form-group">
                <label for="login-password" class="form-label">Contrase침a</label>
                <input type="password" id="login-password" class="form-input" required>
            </div>
            <button type="submit" class="login-btn">Acceder</button>
        </form>
    </div>

    <div id="malla-section" class="container hidden">
        <div class="filters">
            <img src="images.png" alt="ITM Logo" />
            <h2 class="text-xl font-bold text-gray-800 mb-4">Filtros</h2>
            <div class="error-message" id="error-message"></div>
            <div class="success-message" id="success-message"></div> <div class="filter-group">
                <label class="filter-label">Semestre</label>
                <select class="filter-select" id="semester-filter">
                    <option value="all">Todos los Semestres</option>
                    <option value="1">Semestre 1</option>
                    <option value="2">Semestre 2</option>
                    <option value="3">Semestre 3</option>
                    <option value="4">Semestre 4</option>
                    <option value="5">Semestre 5</option>
                    <option value="6">Semestre 6</option>
                    <option value="7">Semestre 7</option>
                    <option value="8">Semestre 8</option>
                    <option value="9">Semestre 9</option>
                    <option value="10">Semestre 10</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Opciones</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="show-prerequisites" class="mr-2 rounded text-blue-600">
                        Mostrar Prerrequisitos
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="hide-completed" class="mr-2 rounded text-blue-600">
                        Ocultar Completados
                    </label>
                </div>
            </div>
            <button class="apply-btn" onclick="applyFilters()">Aplicar Filtros</button>
            <h2 class="text-xl font-bold text-gray-800 mt-6 mb-4">Crear Asignatura</h2>
            <div class="form-group">
                <label class="form-label">C칩digo</label>
                <input type="text" id="new-code" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Asignatura</label>
                <input type="text" id="new-name" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Prerrequisito</label>
                <select id="new-prerequisite" class="form-select">
                    <option value="">Ninguno</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Tipo De Asignatura</label>
                <select id="new-color" class="form-select" required>
                    <option value="course-green">Ciencias B치sicas</option>
                    <option value="course-blue">Ciencias B치sicas Tecnolog칤a - Ingenier칤a</option>
                    <option value="course-purple">Formaci칩n Profesional</option>
                    <option value="course-red">Formaci칩n Complementaria</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Semestre</label>
                <select id="new-semester" class="form-select" required>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                </select>
            </div>
            <button class="submit-btn" onclick="createCourse()">Crear Asignatura</button>
            <button class="logout-btn" onclick="logout()">Cerrar Sesi칩n</button>
        </div>
        <div class="courses">
            <div class="header">
                <h1>Malla Curricular - ITM</h1>
            </div>
            <button class="retry-btn" onclick="fetchCourses()">Reintentar Carga de Cursos</button>
            <button class="export-btn" onclick="exportToPDF()">Exportar Malla a PDF</button>
            <button class="save-btn" onclick="saveMalla()">Guardar Malla</button>
            <div class="semester-grid" id="semester-grid"></div>
        </div>
        <div class="color-palette">
            <h4>Leyenda de Colores</h4>
            <div class="color-item">
                <div class="color-swatch" style="background-color: #10b981;"></div>
                <span>Ciencias B치sicas</span>
            </div>
            <div class="color-item">
                <div class="color-swatch" style="background-color: #3b82f6;"></div>
                <span>Ciencias B치sicas Tecnolog칤a - Ingenier칤a</span>
            </div>
            <div class="color-item">
                <div class="color-swatch" style="background-color: #8b5cf6;"></div>
                <span>Formaci칩n Profesional</span>
            </div>
            <div class="color-item">
                <div class="color-swatch" style="background-color: #ef4444;"></div>
                <span>Formaci칩n Complementaria</span>
            </div>
        </div>
    </div>

    <script>
        let courses = {};
        const addedCourses = new Map();
        const API_BASE_URL = 'http://localhost:49513'; // Aseg칰rate de que este puerto sea el correcto

        // --- Funciones de Autenticaci칩n ---

        async function handleLogin(event) {
            event.preventDefault(); // Evita que el formulario se env칤e de forma tradicional

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginErrorMessage = document.getElementById('login-error-message');
            loginErrorMessage.style.display = 'none';

            // Construye los datos como x-www-form-urlencoded
            const formData = new URLSearchParams();
            formData.append('Email', email);
            formData.append('Contrasena', password);

            try {
                const response = await fetch(`${API_BASE_URL}/Auth/Login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded', // Es crucial para el backend de MVC
                        'Accept': 'application/json' // Decimos que esperamos JSON de vuelta
                    },
                    body: formData.toString() // Convierte URLSearchParams a string
                });

                if (response.ok) {
                    const data = await response.json(); // Esperamos un JSON como respuesta exitosa
                    if (data.success) {
                        // Login exitoso: Almacena info de sesi칩n (ej: ID de usuario)
                        localStorage.setItem('isAuthenticated', 'true');
                        localStorage.setItem('userId', data.userId);
                        localStorage.setItem('userName', data.userName); // Opcional: almacenar el nombre de usuario

                        showMallaSection(); // Mostrar la interfaz de la malla
                        fetchCourses(); // Cargar los cursos
                    } else {
                        // El servidor devolvi칩 칠xito HTTP (200), pero la l칩gica de negocio indica fallo
                        loginErrorMessage.textContent = data.message || 'Credenciales incorrectas.';
                        loginErrorMessage.style.display = 'block';
                    }
                } else {
                    // Si la respuesta HTTP no es OK (ej. 400 Bad Request por validaci칩n)
                    // El backend MVC para un modelo inv치lido devuelve la vista HTML con errores.
                    // Para este frontend, si no es 200, asumimos error.
                    if (response.headers.get('Content-Type')?.includes('text/html')) {
                        // Si devuelve HTML, probablemente son errores de validaci칩n de MVC.
                        // Podr칤amos intentar parsear el HTML para mostrar los errores,
                        // pero por simplicidad, un mensaje gen칠rico.
                        loginErrorMessage.textContent = `Error de validaci칩n en el servidor. Verifica tus datos.`;
                    } else {
                        const errorData = await response.json(); // Intentar leer como JSON
                        loginErrorMessage.textContent = errorData.message || `Error en el servidor: ${response.status} ${response.statusText}`;
                    }
                    loginErrorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error durante el inicio de sesi칩n:', error);
                loginErrorMessage.textContent = `No se pudo conectar al servidor: ${error.message}. Aseg칰rate de que el backend est칠 ejecut치ndose.`;
                loginErrorMessage.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            showLoginSection();
            // Opcional: podr칤as hacer un fetch al endpoint de Logout del backend
            // para limpiar la sesi칩n del lado del servidor, aunque si usas JWT
            // esto no ser칤a tan cr칤tico.
            // fetch(`${API_BASE_URL}/Auth/Logout`, { method: 'POST' });
        }

        function checkAuthAndRender() {
            if (localStorage.getItem('isAuthenticated') === 'true') {
                showMallaSection();
                fetchCourses();
            } else {
                showLoginSection();
            }
        }

        function showLoginSection() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('malla-section').classList.add('hidden');
        }

        function showMallaSection() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('malla-section').classList.remove('hidden');
        }

        // --- Funciones existentes de la Malla Curricular ---

        async function fetchCourses() {
            const errorMessage = document.getElementById('error-message');
            errorMessage.style.display = 'none';
            const grid = document.getElementById('semester-grid');
            grid.innerHTML = '<p class="text-center">Cargando cursos...</p>';
            try {
                const response = await fetch(`${API_BASE_URL}/api/cursos/todos`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                courses = {};
                data.forEach(course => {
                    courses[course.Codigo] = {
                        code: course.Codigo,
                        name: course.Asignatura,
                        prerequisite: course.Prerequisito || '',
                        color: course.Color,
                        semester: course.Semestre,
                        credits: course.Creditos
                    };
                });

                // 游댳 Llenar lista de prerrequisitos din치micamente
                const prereqSelect = document.getElementById('new-prerequisite');
                prereqSelect.innerHTML = `<option value="">Ninguno</option>`;
                Object.values(courses).forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.code; // usar el c칩digo como valor
                    opt.textContent = `${c.name} (${c.code})`; // mostrar nombre + c칩digo
                    prereqSelect.appendChild(opt);
                });

                renderSemesters();
            } catch (error) {
                console.error('Error al cargar los cursos:', error);
                errorMessage.textContent = `No se pudieron cargar los cursos: ${error.message}.`;
                errorMessage.style.display = 'block';
                grid.innerHTML = '<p class="text-center text-red-600">Error al cargar la malla.</p>';
            }
        }



        function renderSemesters() {
            const grid = document.getElementById('semester-grid');
            grid.innerHTML = '';

            for (let i = 1; i <= 10; i++) {
                const semester = document.createElement('div');
                semester.className = 'semester';
                semester.setAttribute('data-semester', i);
                semester.innerHTML = `
                <h3>Semestre ${i}</h3>
                <select class="course-select" onchange="addCourse(this, ${i})">
                    <option value="">Seleccione un curso...</option>
                    ${Object.values(courses)
                        .filter(c => c.semester === i && !addedCourses.has(c.code))
                        .map(c => `<option value="${c.code}">${c.name}</option>`)
                        .join('')}
                </select>
                <div id="courses-semester-${i}"></div>
            `;
                grid.appendChild(semester);
            }

            addedCourses.forEach((semester, courseCode) => {
                const course = courses[courseCode];
                if (course) {
                    const courseList = document.getElementById(`courses-semester-${semester}`);
                    const courseDiv = document.createElement('div');
                    courseDiv.className = `course ${course.color}`;
                    courseDiv.setAttribute('data-code', courseCode);
                    courseDiv.setAttribute('data-semester', semester);

                    const creditText = (typeof course.credits === 'number' && !isNaN(course.credits))
                        ? `${course.credits} cr칠dito${course.credits === 1 ? '' : 's'}`
                        : 'Sin cr칠ditos';

                    courseDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="course-title">${course.name}</div>
                            <div class="course-code">${course.code}</div>
                            <div class="course-prerequisite">Prerrequisito: ${course.prerequisite || 'Ninguno'}</div>
                        </div>
                        <div class="text-sm text-indigo-700 font-semibold bg-indigo-100 px-2 py-1 rounded ml-2 whitespace-nowrap">
                            ${creditText}
                        </div>
                    </div>
                    <button class="remove-btn mt-1" onclick="removeCourse(this, '${courseCode}')">Remover</button>
                `;
                    courseList.appendChild(courseDiv);
                }
            });

            applyFilters();
            computeSemesterSums();
        }


        function addCourse(select, semester) {
            const courseCode = select.value;
            if (!courseCode || addedCourses.has(courseCode)) return;

            const course = courses[courseCode];
            if (!course) {
                console.error(`Curso no encontrado: ${courseCode}`);
                return;
            }

            addedCourses.set(courseCode, semester);
            renderSemesters();
            select.value = '';
        }

        function removeCourse(button, courseCode) {
            addedCourses.delete(courseCode);
            renderSemesters();
        }

        async function createCourse() {
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            const code = document.getElementById('new-code').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const prerequisite = document.getElementById('new-prerequisite').value; // ahora es el c칩digo seleccionado
            const color = document.getElementById('new-color').value;
            const semester = parseInt(document.getElementById('new-semester').value);

            if (!code || !name || !color || isNaN(semester)) {
                errorMessage.textContent = 'Por favor, completa todos los campos obligatorios.';
                errorMessage.style.display = 'block';
                return;
            }

            const newCourse = {
                Codigo: code,
                Asignatura: name,
                Prerequisito: prerequisite || null, // guardar c칩digo del curso como requisito
                Color: color,
                Semestre: semester
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/cursos/crear`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(newCourse)
                });

                if (!response.ok) {
                    let errorText = `Error HTTP: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData?.message) errorText = errorData.message;
                    } catch { }
                    throw new Error(errorText);
                }

                document.getElementById('new-code').value = '';
                document.getElementById('new-name').value = '';
                document.getElementById('new-prerequisite').value = '';
                document.getElementById('new-color').value = 'course-green';
                document.getElementById('new-semester').value = '1';

                successMessage.textContent = 'Asignatura creada exitosamente.';
                successMessage.style.display = 'block';
                setTimeout(() => successMessage.style.display = 'none', 3000);

                await fetchCourses(); // recargar cursos
            } catch (error) {
                console.error('Error al crear el curso:', error);
                errorMessage.textContent = `Error al crear el curso: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        }


        function applyFilters() {
            const semesterFilter = document.getElementById('semester-filter').value;
            const showPrerequisites = document.getElementById('show-prerequisites').checked;
            const hideCompleted = document.getElementById('hide-completed').checked;

            document.querySelectorAll('.semester').forEach(semester => {
                const semesterNum = semester.getAttribute('data-semester');
                semester.style.display = (semesterFilter === 'all' || semesterFilter === semesterNum) ? 'block' : 'none';
            });

            document.querySelectorAll('.course-prerequisite').forEach(prereq => {
                prereq.style.display = showPrerequisites ? 'block' : 'none';
            });

            document.querySelectorAll('.course').forEach(course => {
                // Simplificado: si hideCompleted est치 activo, siempre oculta, sino siempre muestra.
                // Si realmente tienes un estado de "completado" para los cursos, necesitar칤as
                // una propiedad en el objeto `course` para verificar.
                course.style.display = hideCompleted ? 'none' : 'block';
            });
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait', // Cambia a 'landscape' si prefieres horizontal
                unit: 'mm',
                format: 'a4'
            });

            // 游댳 Elementos principales
            const coursesSection = document.querySelector('.courses');
            const filtersSection = document.querySelector('.filters');
            const retryBtn = document.querySelector('.retry-btn');
            const exportBtn = document.querySelector('.export-btn');
            const saveBtn = document.querySelector('.save-btn');
            const colorPalette = document.querySelector('.color-palette');
            const logoutBtn = document.querySelector('.logout-btn');

            // 游댳 Todos los selects y botones "Remover" de todos los semestres
            const courseSelects = document.querySelectorAll('.course-select');
            const removeButtons = document.querySelectorAll('.remove-btn');

            // 游댳 Ocultar elementos no deseados
            [filtersSection, retryBtn, exportBtn, saveBtn, colorPalette, logoutBtn].forEach(el => {
                if (el) el.style.display = 'none';
            });
            courseSelects.forEach(sel => sel.style.display = 'none');
            removeButtons.forEach(btn => btn.style.display = 'none');

            try {
                // Captura directamente lo visible
                const canvas = await html2canvas(coursesSection, {
                    scale: 2, // mejor calidad visual
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    scrollX: 0,
                    scrollY: 0
                });

                // Convertir a imagen y agregar al PDF
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const imgWidth = 190;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 20;

                doc.setFontSize(16);
                doc.text('Malla Curricular - ITM', 10, 10);

                doc.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - position - 10);

                // A침adir m치s p치ginas si el contenido no cabe
                while (heightLeft > 0) {
                    doc.addPage();
                    position = 10;
                    doc.addImage(imgData, 'JPEG', 10, position - heightLeft, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - 10);
                }

                // Guardar el archivo
                doc.save('malla_curricular.pdf');
            } catch (error) {
                console.error('Error al generar el PDF:', error);
                const errorMsg = document.getElementById('error-message');
                if (errorMsg) {
                    errorMsg.textContent = 'Error al generar el PDF. Revisa la consola.';
                    errorMsg.style.display = 'block';
                }
            } finally {
                // 游댳 Restaurar todo a su estado normal
                [filtersSection, retryBtn, exportBtn, saveBtn, colorPalette, logoutBtn].forEach(el => {
                    if (el) el.style.display = 'block';
                });
                courseSelects.forEach(sel => sel.style.display = 'block');
                removeButtons.forEach(btn => btn.style.display = 'block');
            }
        }



        async function saveMalla() {
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            // 游댳 Pedir nombre de la malla
            const nombreMalla = prompt("Ingrese un nombre para la malla:");
            if (!nombreMalla || nombreMalla.trim() === "") {
                alert("Debe ingresar un nombre para la malla.");
                return;
            }

            const malla = {
                nombre: nombreMalla.trim(),
                courses: Array.from(addedCourses).map(([code, semester]) => ({
                    Codigo: code,
                    Semestre: semester
                }))
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/mallas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(malla)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error HTTP: ${response.status} ${response.statusText}`);
                }
                successMessage.textContent = 'Malla guardada exitosamente.';
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Error al guardar la malla:', error);
                errorMessage.textContent = `Error al guardar la malla: ${error.message}.`;
                errorMessage.style.display = 'block';
            }
        }
        function computeSemesterSums() {
            for (let i = 1; i <= 10; i++) {
                const cont = document.getElementById(`courses-semester-${i}`);
                if (!cont) continue;

                const cursos = cont.querySelectorAll(".course");
                const prev = cont.querySelector(".summary-box");
                if (prev) prev.remove();

                if (cursos.length) {
                    let s1 = 0, s2 = 0, s3 = 0, s4 = 0, s5 = 0;

                    cursos.forEach(c => {
                        if (c.classList.contains("disabled")) return;
                        s1 += parseInt(c.querySelector(".supIzq")?.textContent || 0);
                        s2 += parseInt(c.querySelector(".infIzq")?.textContent || 0);
                        s3 += parseInt(c.querySelector(".supDer")?.textContent || 0);
                        s4 += parseInt(c.querySelector(".infDer")?.textContent || 0);
                        s5 += parseInt(c.querySelector(".creditos")?.textContent || 0);
                    });

                    const box = document.createElement("div");
                    box.className = "summary-box mt-4";
                    box.innerHTML = `
                <div class="summary-cell">${s1}</div>
                <div class="summary-cell">${s2}</div>
                <div class="summary-cell">${s5}</div>
                <div class="summary-cell">${s3}</div>
                <div class="summary-cell">${s4}</div>
                <div class="summary-cell">${s5}</div>`;
                    cont.appendChild(box);
                }
            }
        }



        // --- Inicializaci칩n ---

        document.addEventListener('DOMContentLoaded', () => {
            // Asigna el evento submit al formulario de login
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            checkAuthAndRender();
        });
    </script>
</body>
</html>